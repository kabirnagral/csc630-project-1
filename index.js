/* jshint esversion: 6*/

var pg = require("pg");
var express = require("express");
var bodyParser = require('body-parser');
var NodeGeocoder = require("node-geocoder");


var geocoder = NodeGeocoder({
  provider: 'google',
  apiKey: process.env.GOOGLE_API,
});

console.log(geocoder);

var pool = new pg.Pool();
var app = express();

app.use(bodyParser());

app.get("/table/drop", function(req, res){
  pool.query('DROP TABLE Users', function(err, res){
    console.log(err, res);
  });
});

/*
  CREATE TABLES
*/


//SOURCE: https://stackoverflow.com/questions/9875223/auto-increment-table-column
pool.query('CREATE TABLE Users (UserID int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, DisplayName varchar(255), UserName varchar(255), LatLong varchar(255))', function(err, res){
  console.log(err, res);
});

pool.query('CREATE TABLE Addresses (AddressID int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, AddressTitle varchar(255),Address varchar(255), Lat float(5), Long float(5), UserID int)', function(err, res){
  console.log(err, res);
});

/*
  ADDRESSES
*/

// Create address
app.post("/address/create", function(req, res){
  geocoder.geocode(req.body.address, function(err, res) {
    pool.query(`INSERT INTO Addresses (AddressTitle,Address,Lat,Long,UserID) VALUES ('${req.body.addressTitle}','${req.body.address}',${res[0].latitude},${res[0].longitude},${req.body.userID});`, function(err, res){
      console.log("Created Address");
      console.log(err, res);
    });
  });
});

/*
  USERS
*/


// Creates a User
app.post("/user/create", function(req, res){
  pool.query(`INSERT INTO Users (DisplayName,UserName,LatLong) VALUES ('${req.body.displayName}','${req.body.userName}','${req.body.latLong}');`, function(err, res){
    console.log("Created USER");
    console.log(err, res);
  });
});

// Updates a User
app.post("/user/update", function(req, res){
  pool.query(
    `UPDATE Users
    SET DisplayName = '${req.body.displayName}', UserName = '${req.body.userName}', LatLong = '${req.body.latLong}'
    WHERE UserID = '${req.body.userID}';`, function(err, res){
    console.log("Updated USER");
    console.log(err, res);
  });
});

// Deletes a User
app.post("/user/delete", function(req, res){
  pool.query(
    `DELETE FROM Users
    WHERE UserID = '${req.body.userID}';`, function(err, res){
    console.log("Deleted USER");
    console.log(err, res);
  });
});

app.listen(process.env.PORT || 3000, function(){
  console.log("Listening on " + (process.env.PORT));
});
